<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
		<meta name="description" content="">
		<meta name="author" content="Mark Otto, Jacob Thornton, and Bootstrap contributors">
		<meta name="generator" content="Jekyll v4.1.1">
		<title>Symbols Â· Test</title>
		
		<link rel="canonical" href="https://getbootstrap.com/docs/4.5/examples/cover/">
		
		<!-- Bootstrap core CSS -->
		<link href="../../css/bootstrap/bootstrap.min.css" rel="stylesheet">
		
		<style>
			canvas {
				border: 1px solid black;
			}
			
			.bd-placeholder-img {
				font-size: 1.125rem;
				text-anchor: middle;
				-webkit-user-select: none;
				-moz-user-select: none;
				-ms-user-select: none;
				user-select: none;
			}
			.instruct {
            width: 400px;
            padding: 30px;
            margin: 100px auto;
            border-radius: 10px;
            background: white;
            box-shadow: 0px 0px 8px rgba(0, 0, 0, 0.1);
            text-align: center;
            color: #282828;
        }

			
			@media (min-width: 768px) {
				.bd-placeholder-img-lg {
					font-size: 3.5rem;
				}
			}
		</style>
		<!-- Custom styles for this template -->
		<link href="../../css/cover.css" rel="stylesheet">
		
	</head>
	<body class="text-center">
		<div class="cover-container d-flex w-100 h-100 p-3 mx-auto flex-column">
			<header class="masthead mb-auto">
				<div class="inner">
					<h3 class="masthead-brand">Vision Monitor</h3>
					<nav class="nav nav-masthead justify-content-center">
						<a class="nav-link active" href="../../home.html">Home</a>
						<a class="nav-link" href="../../dashboard.html">My Dashboard</a>
					</nav>
				</div>
			</header>
			
			<main role="main" class="inner cover">
				<div style="text-align: center;">
					<canvas id="canvas1"></canvas>
					<canvas id="canvas2"></canvas>
				</div>
				<div style="text-align: center;" id="start_test1">
					<button onclick="rightEyeTest()">Start</button>
				</div>
				<div style="text-align: center; display: none" id="start_test2">
					<button onclick="leftEyeTest()">Next Eye</button>
				</div>
				<div class="instruct" id="nextEye">
					<p>
						Great! Now cover your left eye, and with your right eye focus on the black dot in the center.
						Follow same directions as previous test.
					</p>
					<button onclick="leftEyeTest()" id="nexttestbtn" class="btn btn-sm btn-outline-secondary"
						style="color: #282828; border-color: #282828;">Start next eye</button>
				</div>
		

			</main>
			
			<div>
				<!-- These buttons will only become visible once the user has finished the test -->
				<div class="btn-group" id="exitTestBtns" style="display: none">
					<button type="button" onClick="sendToFirestore();showStatusIndicator();"
							class="btn btn-sm btn-outline-secondary">
						Upload Results
					</button>
					<button type="button" onClick="location.href='../../home.html'"
							class="btn btn-sm btn-outline-secondary">
						Exit without Upload
					</button>
					<p id="uploadStatus" style="display: none">
						<br>Uploading Your Results...
					</p>
				</div>
			</div>
			
			<footer class="mastfoot mt-auto">
				<div class="inner">
				</div>
			</footer>
		
		</div>
		
		
		<!-- Firebase App (the core Firebase SDK) is always required and must be listed first -->
		<script src="/__/firebase/7.23.0/firebase-app.js"></script>
		
		<!-- If you enabled Analytics in your project, add the Firebase SDK for Analytics -->
		<script src="/__/firebase/7.23.0/firebase-analytics.js"></script>
		
		<!-- Add Firebase products that you want to use -->
		<script src="/__/firebase/7.23.0/firebase-auth.js"></script>
		<script src="/__/firebase/7.23.0/firebase-firestore.js"></script>

		
		<!-- Initialize Firebase -->
		<script src="/__/firebase/init.js"></script>
		<!-- <script src="../../auth.js"></script> -->
		<script src="symbolsTest.js"></script>
		
		<script>
			let dbRef = firebase.firestore();
			let userRef = null;
			
			firebase.auth().onAuthStateChanged(user => {
				console.log("[symbolsTest.html] - USER LOCATED");
				console.log(user);
				userRef = user;
			});
		</script>
		
		<script>
			// !! TODO: Handle errors with getsybolsTestResults()
			// !! TODO: Docstrings and comments
			// If Time: Use event listeners instead of onclick (Unobtrusive Javascript)
			let maxWaitTime = 2000;
			let waitTime = 200;
			
			function sendToFirestore() {
				attemptUserLookup();
				
				var dataToWrite = getSymbolsResults();
				
				if (userRef) {
					dbRef.collection("TestResults")
						.doc(userRef.uid)
						.collection("Symbols")
						.add(dataToWrite)
						.then(() => {
							uploadSuccess();
							setTimeout(() => {
								// Use replace() to disallow back button to come back to this page
								window.location.replace("../../home.html");
							}, 1000);
						});
				}
			}
			
			function attemptUserLookup() {
				if (!userRef && maxWaitTime > 0) {
					maxWaitTime -= waitTime;
					console.log("No User. Reattempting Lookup.");
					setTimeout(attemptUserLookup, waitTime);
				}
				else if (maxWaitTime < 0) {
					userLookupFailed();
				}
			}
			
			function uploadSuccess() {
				let uploadStatusIndicator = document.getElementById('uploadStatus');
				uploadStatusIndicator.textContent = "Results Saved!";
			}
			
			function userLookupFailed() {
				// TODO: Better error message and format
				let uploadStatusIndicator = document.getElementById('uploadStatus');
				uploadStatusIndicator.textContent = "Upload failed. Please Try Again Later.";
			}
		</script>
		
		<script>
			function showStatusIndicator() {
				let uploadStatusIndicator = document.getElementById('uploadStatus');
				uploadStatusIndicator.style.display = "inherit";
			}
		</script>
	</body>
</html>




